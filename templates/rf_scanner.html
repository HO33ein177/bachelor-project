{% extends 'base.html' %}
{% load static %}

{% block title %}RF Simulator (Time & Spectrum){% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        /* Existing styles from rf_scanner.html */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .control-group {
            padding: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: rgba(255,255,255,0.05); /* Slightly transparent background for the group */
        }
        .control-group h3 {
            margin-top: 0;
            color: #00aaff; /* A distinct color for headings */
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            margin-top: 10px; /* Add some space above labels */
            margin-bottom: 5px;
            color: #ccc;
            font-size: 0.9em;
        }
        .control-group input[type="number"], .control-group input[type="text"] {
            width: calc(100% - 16px); /* Adjust width to fit padding */
            padding: 8px; /* More padding */
            margin-bottom: 10px;
            background-color: #333;
            color: #eee;
            border: 1px solid #666;
            border-radius: 3px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .control-btn {
            padding: 10px 15px; /* More padding for buttons */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right:5px;
            margin-top: 10px; /* Space above buttons */
            font-size: 0.95em;
        }
        .control-btn.stop {
            background-color: #f44336;
        }
        .control-btn:hover {
            opacity: 0.85;
        }
        #rf-status {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 4px;
            color: #ddd;
            text-align: center; /* Center status text */
        }
        .chart-pair-container {
            display: flex;
            flex-wrap: wrap; /* Allow charts to wrap on smaller screens */
            gap: 20px;
            justify-content: space-around; /* Distribute space */
            margin-top: 20px;
        }
        .chart-container {
            width: 100%; /* Full width on small screens */
            max-width: 700px;
            min-width: 300px; /* Prevent charts from becoming too small */
            flex-grow: 1; /* Allow charts to grow */
            flex-basis: 45%; /* Try to fit two charts side-by-side if space allows */
            background-color: #22252a; /* Dark background for chart area */
            padding:15px;
            border-radius:5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        h1, h2.chart-title {
            color: #00aaff;
            text-align: center;
            margin-bottom: 15px;
        }

        /* --- NEW STYLES FOR POP-UP MENU --- */
        .popup-controls-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top of everything */
        }

        .popup-controls-content {
            background-color: #1a1a1a; /* Dark background for the popup */
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); /* Glowing effect */
            max-width: 500px; /* Max width for the popup */
            width: 90%;
            position: relative;
            transform: scale(0.9); /* Slightly smaller initially */
            transition: transform 0.3s ease-out; /* Smooth scale transition */
            max-height: 80vh; /* Make it scrollable if content overflows */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .popup-controls-overlay.active .popup-controls-content {
            transform: scale(1); /* Scale to normal when active */
        }

        .popup-controls-content .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #fff;
            cursor: pointer;
        }

        .popup-controls-content h2 {
            color: #00aaff;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        /* Make controls grid more compact within the popup */
        .popup-controls-content .controls-grid {
            grid-template-columns: 1fr; /* Stack groups vertically in popup */
            gap: 10px; /* Reduce gap */
            margin-bottom: 15px;
        }
        .popup-controls-content .control-group {
            padding: 10px; /* Reduce padding */
            margin-bottom: 0;
        }
        .popup-controls-content .control-group label {
            margin-top: 5px; /* Reduce margin */
            margin-bottom: 2px;
        }
        .popup-controls-content .control-group input {
            margin-bottom: 5px; /* Reduce margin */
        }

        /* Style for the trigger button */
        #openControlsButton {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 20px auto;
            display: block; /* Center the button */
        }
        #openControlsButton:hover {
            background-color: #0056b3;
        }

        /* NEW STYLES for input pairs (min/max) */
        .input-pair {
            display: flex;
            gap: 10px; /* Space between min and max inputs */
            margin-bottom: 10px;
        }
        .input-pair > div {
            flex: 1; /* Make each input container take equal space */
        }
        .input-pair label {
            margin-bottom: 0; /* Adjust label margin within pair */
        }
        .input-pair input {
            width: calc(100% - 10px); /* Adjust width in pair */
        }
    </style>
{% endblock %}

{% block content %}
    <h1>Simulated RF Analyzer (Time Domain & Spectrum)</h1>

    <button id="openControlsButton">Open Controls</button>

    <div class="popup-controls-overlay" id="popupControls">
        <div class="popup-controls-content">
            <button class="close-btn" id="closeControlsButton">&times;</button>
            <h2>Analyzer Controls</h2>

            <div class="controls-grid">
                <div class="control-group">
                    <h3>Simulation Control</h3>
                    <button id="startSimButton" class="control-btn">Start Simulation</button>
                    <button id="stopSimButton" class="control-btn stop">Stop Simulation</button>
                </div>

                <div class="control-group">
                    <h3>Waveform Parameters</h3> <h4>Main Wave</h4>
                    <label for="waveFreq">Frequency (MHz):</label>
                    <input type="number" id="waveFreq" value="10" step="1">
                    <label for="waveAmp">Amplitude (V):</label>
                    <input type="number" id="waveAmp" value="1.0" step="0.1">
                    <label for="noiseAmp">Noise Amplitude (V):</label>
                    <input type="number" id="noiseAmp" value="0.1" step="0.01">

                    <h4>Second Wave</h4>
                    <label for="waveFreq2">Frequency (MHz):</label> <input type="number" id="waveFreq2" value="20" step="1">
                    <label for="waveAmp2">Amplitude (V):</label> <input type="number" id="waveAmp2" value="0.5" step="0.1">

                    <h4>Acquisition Settings</h4>
                    <label for="waveDuration">Sample Duration (µs):</label>
                    <input type="number" id="waveDuration" value="2" step="0.5">
                    <label for="sampleRate">Sample Rate (MSa/s):</label>
                    <input type="number" id="sampleRate" value="500" step="50">
                    <button id="configureCosineButton" class="control-btn">Apply Wave Settings</button>
                </div>

                <div class="control-group">
                    <h3>Chart Scaling</h3>
                    <h4>Time Domain (Amplitude)</h4>
                    <div class="input-pair">
                        <div>
                            <label for="timeAmpMin">Min (V):</label>
                            <input type="number" id="timeAmpMin" step="0.1">
                        </div>
                        <div>
                            <label for="timeAmpMax">Max (V):</label>
                            <input type="number" id="timeAmpMax" step="0.1">
                        </div>
                    </div>

                    <h4>Frequency Spectrum (Power)</h4>
                    <div class="input-pair">
                        <div>
                            <label for="freqPowerMin">Min (dBm):</label>
                            <input type="number" id="freqPowerMin" step="5">
                        </div>
                        <div>
                            <label for="freqPowerMax">Max (dBm):</label>
                            <input type="number" id="freqPowerMax" step="5">
                        </div>
                    </div>

                    <h4>Frequency Spectrum (Frequency)</h4>
                    <div class="input-pair">
                        <div>
                            <label for="freqAxisMin">Min (MHz):</label>
                            <input type="number" id="freqAxisMin" step="10">
                        </div>
                        <div>
                            <label for="freqAxisMax">Max (MHz):</label>
                            <input type="number" id="freqAxisMax" step="10">
                        </div>
                    </div>
                    <button id="applyChartScaleButton" class="control-btn">Apply Scale</button>
                    <button id="autoscaleChartButton" class="control-btn">Autoscale</button>
                </div>
            </div>
        </div>
    </div>

    <div id="rf-status">Status: Idle</div>

    <div class="chart-pair-container">
        <div class="chart-container">
            <h2 class="chart-title">Time Domain Waveform</h2>
            <canvas id="waveformChart"></canvas>
        </div>
        <div class="chart-container">
            <h2 class="chart-title">Frequency Spectrum</h2>
            <canvas id="fftSpectrumChart"></canvas>
        </div>
    </div>

    <script>
        // --- EXISTING JAVASCRIPT ---
        const rfStatusSpan = document.getElementById('rf-status');
        const startSimButton = document.getElementById('startSimButton');
        const stopSimButton = document.getElementById('stopSimButton');
        const configureCosineButton = document.getElementById('configureCosineButton');

        // --- POP-UP JAVASCRIPT ---
        const openControlsButton = document.getElementById('openControlsButton');
        const closeControlsButton = document.getElementById('closeControlsButton');
        const popupControls = document.getElementById('popupControls');

        openControlsButton.onclick = () => {
            popupControls.style.display = 'flex';
            popupControls.classList.add('active');
        };

        closeControlsButton.onclick = () => {
            popupControls.classList.remove('active');
            setTimeout(() => {
                popupControls.style.display = 'none';
            }, 300);
        };

        // --- Chart.js setup for Time-Domain Waveform ---
        const ctxTime = document.getElementById('waveformChart').getContext('2d');
        let waveformChart = new Chart(ctxTime, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{ // Dataset 0: Main Wave
                    label: 'Main Wave (V)',
                    data: [],
                    borderColor: 'rgb(120, 190, 255)', // Light blue / cyan
                    borderWidth: 1.5,
                    tension: 0.1,
                    pointRadius: 0,
                },
                { // Dataset 1: Secondary Wave (NEW)
                    label: 'Second Wave (V)',
                    data: [],
                    borderColor: 'rgb(255, 165, 0)', // Orange for distinction
                    borderWidth: 1.5,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false // Set to true to hide by default
                }]
            },
            options: {
                animation: false,
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Time (µs)', color: '#ccc' },
                        ticks: { color: '#ccc', maxTicksLimit: 10 },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        title: { display: true, text: 'Amplitude (V)', color: '#ccc' },
                        ticks: { color: '#ccc' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        suggestedMin: -1.5,
                        suggestedMax: 1.5,
                        min: undefined,
                        max: undefined
                    }
                },
                plugins: {
                    legend: { labels: { color: '#ccc' } },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                            threshold: 10
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                }
            }
        });

        // --- Chart.js setup for Frequency Spectrum ---
        const ctxFreq = document.getElementById('fftSpectrumChart').getContext('2d');
        let fftSpectrumChart = new Chart(ctxFreq, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Power (dBm)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1.5,
                    tension: 0.1,
                    pointRadius: 0,
                }]
            },
            options: {
                animation: false,
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Frequency (MHz)', color: '#ccc' },
                        ticks: { color: '#ccc', maxTicksLimit: 10 },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        min: undefined,
                        max: undefined
                    },
                    y: {
                        title: { display: true, text: 'Power (dBm)', color: '#ccc' },
                        ticks: { color: '#ccc' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        suggestedMin: -100,
                        suggestedMax: 0,
                        min: undefined,
                        max: undefined
                    }
                },
                plugins: {
                    legend: { labels: { color: '#ccc' } },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                            threshold: 10
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                }
            }
        });

        // WebSocket setup
        const rfWsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const rfWsPath = rfWsScheme + '://' + window.location.host + '/ws/rf_spectrum/';
        console.log("RF Simulator: Connecting to WebSocket:", rfWsPath);
        const rfSocket = new WebSocket(rfWsPath);

        rfSocket.onopen = function(e) {
            console.log('RF Simulator: WebSocket connection opened!');
            rfStatusSpan.textContent = 'Status: Connected. Ready.';
        };

rfSocket.onmessage = function(e) {
    console.log('Raw WebSocket message received:', e.data);

    try {
        const data = JSON.parse(e.data);
        console.log('Parsed WebSocket data object:', data);
        console.log('Message Type received:', data.type);

        if (data.type === 'rf_simulated_data') {
            const payload = data.payload;
            console.log('Received RF Data Payload:', payload);

            // --- CORRECTION 1: Check for non-empty arrays ---
            // Update Time-Domain Chart only if there's data
            if (payload.time_s && payload.time_s.length > 0 && payload.amplitude_v && payload.amplitude_v.length > 0) {
                waveformChart.data.labels = payload.time_s.map(t => (t * 1e6).toFixed(3)); // Time in µs
                waveformChart.data.datasets[0].data = payload.amplitude_v;
                waveformChart.update('none');
            }

            // --- CORRECTION 2: Check for non-empty arrays ---
            // Update Frequency Spectrum Chart only if there's data
            if (payload.fft_frequencies_hz && payload.fft_frequencies_hz.length > 0 && payload.fft_power_dbm && payload.fft_power_dbm.length > 0) {
                fftSpectrumChart.data.labels = payload.fft_frequencies_hz.map(f => (f / 1e6).toFixed(2)); // Freq in MHz
                fftSpectrumChart.data.datasets[0].data = payload.fft_power_dbm;
                
                // Only autoscale if manual scale isn't set
                if (fftSpectrumChart.options.scales.x.min === undefined && fftSpectrumChart.options.scales.x.max === undefined) {
                    fftSpectrumChart.options.scales.x.suggestedMin = parseFloat(payload.fft_frequencies_hz[0] / 1e6);
                    fftSpectrumChart.options.scales.x.suggestedMax = parseFloat(payload.fft_frequencies_hz[payload.fft_frequencies_hz.length - 1] / 1e6);
                }
                fftSpectrumChart.update('none');
            }
            
            if (payload.wave_details){
                rfStatusSpan.textContent = `Status: Displaying (Time Points: ${payload.wave_details.num_points_time})`;
            }

        } else if (data.type === 'command_response' || data.type === 'status_update' || data.type === 'error_response') {
            rfStatusSpan.textContent = `Status: ${data.message}`;
            console.log("RF Simulator: Server status/response:", data.message);
        }
    } catch (error) {
        console.error("Error parsing or processing WebSocket message:", error, "Raw data:", e.data);
    }
};
        rfSocket.onclose = function(e) {
            console.error('RF Simulator: WebSocket connection closed:', e);
            rfStatusSpan.textContent = `Status: Disconnected - Code: ${e.code}, Reason: ${e.reason || 'N/A'}`;
        };

        rfSocket.onerror = function(e) {
            console.error('RF Simulator: WebSocket error:', e);
            rfStatusSpan.textContent = 'Status: WebSocket error. Check console.';
        };

        // --- Send Commands ---
        function sendRfCommand(command, params = {}) {
            if (rfSocket.readyState === WebSocket.OPEN) {
                rfSocket.send(JSON.stringify({
                    'command_type': 'rf_control',
                    'command': command,
                    'params': params
                }));
                 rfStatusSpan.textContent = `Status: Sent command '${command}'...`;
            } else {
                console.error('RF Simulator: WebSocket is not open. Cannot send command.');
                rfStatusSpan.textContent = 'Status: Error - WebSocket not open.';
            }
        }

        startSimButton.onclick = () => sendRfCommand('start_simulation');
        stopSimButton.onclick = () => sendRfCommand('stop_simulation');

        configureCosineButton.onclick = () => {
            const params = {
                frequency_hz: parseFloat(document.getElementById('waveFreq').value) * 1e6,
                amplitude_v: parseFloat(document.getElementById('waveAmp').value),
                // NEW: Read second wave parameters
                frequency_hz2: parseFloat(document.getElementById('waveFreq2').value) * 1e6,
                amplitude_v2: parseFloat(document.getElementById('waveAmp2').value),

                duration_s: parseFloat(document.getElementById('waveDuration').value) / 1e6, // convert µs to s
                sample_rate_hz: parseFloat(document.getElementById('sampleRate').value) * 1e6, // convert MSa/s to Sa/s
                noise_v: parseFloat(document.getElementById('noiseAmp').value)
            };
            sendRfCommand('configure_cosine', params);
        };

        // --- JAVASCRIPT FOR CHART SCALING ---
        const timeAmpMinInput = document.getElementById('timeAmpMin');
        const timeAmpMaxInput = document.getElementById('timeAmpMax');
        const freqPowerMinInput = document.getElementById('freqPowerMin');
        const freqPowerMaxInput = document.getElementById('freqPowerMax');
        const freqAxisMinInput = document.getElementById('freqAxisMin');
        const freqAxisMaxInput = document.getElementById('freqAxisMax');
        const applyChartScaleButton = document.getElementById('applyChartScaleButton');
        const autoscaleChartButton = document.getElementById('autoscaleChartButton');

        applyChartScaleButton.onclick = () => {
            // Apply scale to Time Domain (Amplitude)
            waveformChart.options.scales.y.min = timeAmpMinInput.value === "" ? undefined : parseFloat(timeAmpMinInput.value);
            waveformChart.options.scales.y.max = timeAmpMaxInput.value === "" ? undefined : parseFloat(timeAmpMaxInput.value);
            waveformChart.options.scales.y.suggestedMin = undefined; // Clear suggested values when manual set
            waveformChart.options.scales.y.suggestedMax = undefined;

            // Apply scale to Frequency Spectrum (Power)
            fftSpectrumChart.options.scales.y.min = freqPowerMinInput.value === "" ? undefined : parseFloat(freqPowerMinInput.value);
            fftSpectrumChart.options.scales.y.max = freqPowerMaxInput.value === "" ? undefined : parseFloat(freqPowerMaxInput.value);
            fftSpectrumChart.options.scales.y.suggestedMin = undefined; // Clear suggested values
            fftSpectrumChart.options.scales.y.suggestedMax = undefined;

            // Apply scale to Frequency Spectrum (Frequency X-axis)
            fftSpectrumChart.options.scales.x.min = freqAxisMinInput.value === "" ? undefined : parseFloat(freqAxisMinInput.value);
            fftSpectrumChart.options.scales.x.max = freqAxisMaxInput.value === "" ? undefined : parseFloat(freqAxisMaxInput.value);
            fftSpectrumChart.options.scales.x.suggestedMin = undefined; // Clear suggested values
            fftSpectrumChart.options.scales.x.suggestedMax = undefined;


            // Trigger updates after applying new scale options
            waveformChart.update();
            fftSpectrumChart.update();
            rfStatusSpan.textContent = "Status: Chart scale applied.";
        };

        autoscaleChartButton.onclick = () => {
            // Clear inputs
            timeAmpMinInput.value = "";
            timeAmpMaxInput.value = "";
            freqPowerMinInput.value = "";
            freqPowerMaxInput.value = "";
            freqAxisMinInput.value = "";
            freqAxisMaxInput.value = "";

            // Reset chart options to undefined for autoscale
            waveformChart.options.scales.y.min = undefined;
            waveformChart.options.scales.y.max = undefined;
            waveformChart.options.scales.y.suggestedMin = undefined; // Reset suggested as well
            waveformChart.options.scales.y.suggestedMax = undefined;

            fftSpectrumChart.options.scales.y.min = undefined;
            fftSpectrumChart.options.scales.y.max = undefined;
            fftSpectrumChart.options.scales.y.suggestedMin = undefined; // Reset suggested
            fftSpectrumChart.options.scales.y.suggestedMax = undefined;

            fftSpectrumChart.options.scales.x.min = undefined;
            fftSpectrumChart.options.scales.x.max = undefined;
            fftSpectrumChart.options.scales.x.suggestedMin = undefined; // Reset suggested
            fftSpectrumChart.options.scales.x.suggestedMax = undefined;


            // Trigger updates after resetting options
            waveformChart.update();
            fftSpectrumChart.update();
            rfStatusSpan.textContent = "Status: Chart autoscale enabled.";
        };

    </script>
{% endblock %}